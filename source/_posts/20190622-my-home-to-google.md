---
title: 우리 집에서 구글까지는 어떻게 걸릴까?
date: 2019-06-22 00:32:09
tags:
  - 네트워크
  - Network
  - IP
  - 이론
  - Computer Science
categories:
  - Network
thumbnail: /2019/06/22/my-home-to-google/network-structure.png
toc: true
widgets:
  - 
    type: toc
    position: right
  - 
    type: category
    position: right
---

<!--
1. IPv4에 대한 설명
2. 사설IP / 사설망에 대한 설명
3. 우리 집 부터 구글까지 찍고가는 모든 라우터/게이트웨이에 대한 설명 및 예시(traceroute 사용)
4. https://www.ip2location.com/173.252.67.159 로 찾아볼 수 있음

-->

## 들어가며
이번 포스팅에서는 우리 집에서 구글까지 어떤 과정을 통해 통신을 하는지에 대해서 간략하게 얘기해보려고 한다.
<!-- more -->

필자가 대학에서 배운 것 중 재밌다고 생각했던 것이 여러 개 있는데, 그 중 대표적인 것이 바로 `인터넷에 연결되어 있는 모든 컴퓨터는 실제로 케이블을 통해 연결되어있다`라는 사실이었다.
혹자는 당연하다고 생각할 수 있는 이 사실이 그땐 굉장히 신기했던 것 같다. 매일매일 인터넷을 사용하고 있지만 너무 생활 속에 자연스레 녹아있는 요소이다 보니 그 원리에 대해서 신경쓰지 않았기 때문이다. 

그러다가 학교에서 네트워크에 관해 점점 자세히 배우면서 `내가 당연하게 사용하고 있는 이 혜택들이 사실은 굉장히 체계적이고 복잡한 시스템이구나`라는 사실을 알게 되었다.
그래서 이번 포스팅에서는 우리 집에서 구글 서버에 접속하는 과정을 통해 그 시스템에 대해서 간단하게 풀어보려고 한다.

## IP, Internet Protocol
먼저 인터넷하면 빠질 수 없는 `IP`에 대해서 간단하게 설명을 하고 넘어가야 할 것 같다. `IP 주소`라는 단어는 컴퓨터 관련 전공을 하신 분이 아니더라도 굉장히 익숙한 단어이다. 일반적인 환경에서 우리가 인터넷에 접속할 때 이 `IP`가 `우리 집 주소`의 역할을 한다고 생각하면 된다.

`IP`에 관해서 굉장히 기본적인 내용을 설명할 예정이므로 이미 다 아시는 분은 그냥 건너뛰셔도 무방하다.

### IPv4의 구조
일반적으로 우리가 접할 수 있는 `192.168.0.1`과 같은 형태는 `IPv4`이다. IPv4는 `8비트`로 구성된 4개의 필드로 구성되고 이 하나하나의 필드를 `옥탯(Octet)`이라고 부른다. 예를 들어 `192.168.0.1`은 이진법으로 전환하면 다음과 같이 나타낼 수 있다.

```text
10진법: 192.168.0.1
2진법: 11000000.10101000.00000000.00000001
```

한 옥탯에 8비트밖에 가지지 못하기 때문에 옥탯은 `00000000 ~ 11111111`, 즉 십진법으로는 `0~255`의 수를 가지게 되는 것이다. 그렇기 때문에 IPv4로 생성할 수 있는 주소의 개수는 $2^{32} = 4,294,967,296$로 약 43억개이다. 43억개라니... 꽤 큰 숫자 같아 보인다. 처음에 이 주소 체계를 만들 때만 해도 `43억개나 있는데 어느 정도는 버티겠지`라는 생각을 했지만...
 
<center>{% asset_img 'unexpected-result.jpg' %}</center>

생각보다 전세계의 인터넷 사용자가 빠르게 늘면서 결국 `2011년 2월 4일`부로 모든 주소가 소진되어 현재는 IPv4의 할당이 중지되었다.

### IPv4 클래스
이렇게 IP 주소는 무제한으로 막 퍼줄 수 있는 자원이 아니라 유한한 자원이다 보니, 특정 대역마다 사용처를 나누어서 관리하게 된다. 이때 나누어진 사용처를 `클래스`라고 부르고 `A~E`의 총 5개의 클래스로 나누어서 관리한다. 각 클래스는 이진법으로 표현한 IPv4인 `00000000.00000000.00000000.00000000` 중 첫번째 필드에 있는 8비트에 제한을 만들어서 표기하기 때문에 첫번째 필드의 숫자만 보면 해당 IPv4 주소가 어느 클래스에 속해있는 지 알 수 있다.

이 제한은 바로 첫번째 필드의 `최상위 비트`를 강제하는 방식이다. 예를 들어 `A 클래스`는 무조건 비트가 `0`으로 시작해야하기 때문에 `00000000(0)`에서 `01111111(127)`사이의 첫번째 필드를 사용할 수 있고 `C 클래스`는 무조건 비트가 `110`로 시작해야하기 때문에 `11000000(192)`부터 `11011111(223)`까지의 첫번째 필드를 사용할 수 있는 식이다.

| 클래스 | 첫번째필드 | 주소범위 | 용도 |
|---|---|---|
| A | 0xxxxxxx | 0.0.0.0 ~ 127.255.255.255 | 대규모 네트워크 |
| B | 10xxxxxx | 128.0.0.0 ~ 191.255.255.255 | 중규모 네트워크 |
| C | 110xxxxx | 192.0.0.0 ~ 223.255.255.255 | 소규모 네트워크 |
| D | 1110xxxx | 224.0.0.0 ~ 239.255.255.255 | 멀티캐스트 |
| E | 1111xxxx | 240.0.0.0 ~ 255.255.255.255 | 연구/개발 또는 미래 대비로 예약 |

### 특수한 목적의 IPv4 주소
이렇게 클래스를 나누고 그 클래스 내부에서도 특수한 용도를 위해 미리 예약해놓은 IPv4 주소들이 있다. 이 예약 주소들은 [RFC 5735](https://tools.ietf.org/html/rfc5735)에 의해 정의되어 있으며 목적에 벗어난 용도로 할당 받는 것이 불가능하다. 이 포스팅에서는 간략하게 대표적인 몇가지만 설명하고 넘어가겠다.

| 클래스 | 주소 | 용도 |
|--|--|--|
| A | 0.0.0.0 ~ 0.255.255.255 | 할당되지 않은 메타 주소 |
| A | 10.0.0.0 ~ 10.255.255.255 | 대규모 사설 네트워크 |
| A | 100.64.0.0 ~ 100.127.255.255 | Carrier-grade NAT용 주소 |
| A | 127.0.0.0 ~ 127.255.255.255 | 자기 자신. 일명 루프백(Lookback) |
| C | 192.168.0.0 ~ 192.168.255.255 | 소규모 사설 네트워크. 공유기를 쓰면 많이 보인다. |

## 우리 집에서 구글까지의 경로를 보자
자, 드디어 이 포스팅의 메인 내용을 시작할 수 있게 되었다.

먼저 우리 집에서 내 맥북을 열고 웹 브라우저에 `google.com`을 입력하면 웹 브라우저는 전 세계 어딘가에 있는 구글 서버에 페이지를 보내달라는 요청을 보낼 것이다. 근데 생각해보니 내 맥북과 구글 서버까지는 직접 연결되어 있는게 아니다.

내가 보낸 요청은 구글 서버까지 가기 위해 여기저기를 들러가면서 험난한 여정을 겪는다. 그렇다면 내가 보낸 요청이 어디를 들리는 지 알 수 있지 않을까?

### traceroute 사용하기
필자는 `Unix` 기반의 MacOS를 사용하고 있기 때문에 MacOS 기준으로 설명하겠다. `traceroute` 진단 유틸리티를 사용하면 내가 보낸 패킷이 어떤 경로를 통해 구글 서버까지 도달하는 지 알아볼 수 있다.

```bash
$ traceroute -q 1 goolge.com
traceroute to goolge.com (172.217.25.196), 64 hops max, 52 byte packets
 1  192.168.25.1 (192.168.25.1)  2.786 ms
 2  211.0.0.0 (211.201.27.1)  6.553 ms
 3  100.71.51.17 (100.71.51.17)  3.844 ms
 4  10.44.255.158 (10.44.255.158)  3.126 ms
 5  10.222.18.20 (10.222.18.20)  5.360 ms
 6  175.124.53.99 (175.124.53.99)  5.111 ms
 7  10.222.6.100 (10.222.6.100)  5.291 ms
 8  72.14.204.124 (72.14.204.124)  34.539 ms
 9  108.170.242.97 (108.170.242.97)  36.496 ms
10  108.170.233.15 (108.170.233.15)  37.596 ms
11  nrt12s13-in-f196.1e100.net (172.217.25.196)  37.442 ms
```

두번째 홉은 필자의 디테일한 위치가 노출될 수 있는 `IP`를 출력하므로 보안 상 마스킹했다.

`traceroute`의 결과로 출력되는 하나의 row를 `홉(Hop)`이라고 부르는데, 우리 집에서부터 구글의 서버까지 내 패킷이 거쳐간 경로를 의미하는 것이다. 홉의 IPv4 주소 오른쪽에 출력된 시간은 홉이 응답한 시간을 의미한다. 재밌는 것은 8번 홉부터 갑자기 응답 시간이 한자리 수에서 두자리 수로 확 뛴다는 것인데, 여기서부터는 패킷이 국내를 벗어나 해외로 빠져나간 것이다.

그렇다면 이 IP 주소들은 어디를 의미하는 걸까?

### 좀 더 자세히 알아보자!
이제 이 IP 주소들이 각각 어디를 의미하는지, 어떤 회사가 소유하고 있는 디바이스인지 좀 더 자세히 알아보고 싶다. 간단하게 알아보는 방법은 `whois` 유틸리티를 사용하는 방법이 있다.

```bash
$ whois 172.217.25.196
NetRange:       172.217.0.0 - 172.217.255.255
CIDR:           172.217.0.0/16
NetName:        GOOGLE
NetHandle:      NET-172-217-0-0-1
Parent:         NET172 (NET-172-0-0-0-0)
NetType:        Direct Allocation
```

MacOS의 `whois` 유틸리티는 5개의 `whois` 서비스에 쿼리를 보내 받아온 결과를 출력해주는 방식이다.

<center>
  {% asset_img 'whois.png' 'MacOS의 whois 서버 목록' %}
  <sub>MacOS에서 사용하고 있는 whois 서비스 목록</sub>
  <br>
</center>

그러나 `whois` 서비스는 기본적으로 도메인이 등록된 IP의 소유주에 대한 정보를 보여주는 서비스라서 도메인이 등록되지 않은 게이트웨이나 라우터에 대한 정보는 나오지 않는다. 그래서 필자는 [IP2Location](https://www.ip2location.com/demo)이라는 사이트를 이용하여 한번 찾아볼 것이다.<small><strike>(근데 이것도 잘 나올 것 같지는 않다)</strike></small>
먼저 첫번째 홉인 `192.168.25.1`은 동적으로 공유기에서 할당해준 로컬 IP 이고 두번째 홉은 보안 상 마스킹 했으므로 세번째 홉인 `100.71.51.17`부터 한번 살펴보면 좋겠다.

#### 100.71.51.17
<center>
  {% img https://images.ip2location.com/18399031.png %}
</center>

앗 역시 생각보다 정보가 별로 안나왔다. 대신 해당 IP가 `Carrier Grade NAT`에 사용되는 정보를 출력했다. 위에서 설명한 대로 `A 클래스`의 `100.64.0.0 ~ 100.127.255.255` 대역은 `Carrier Grade NAT`에 사용된다는 것은 이미 표준으로 정의된 것이기 때문에 사실 뻔한 결과를 출력한 것이다. 그럼 `Carrier Grade NAT`이 뭐길래 우리 집에서 이렇게 가까운 곳에 있는 것일까?

##### Carrier Grade NAT
우선 `NAT`은 `Network Address Translation`의 약자로 대개 사설 네트워크에 속한 여러 개의 호스트가 하나의 공인 IP를 사용하여 인터넷에 접속하기 위한 기술이다.
보통 네트워크는 `LAN(Local Area Network)`, `MAN(Metropolitan Area Network)`, `Wide Area Network`로 나누어 지는데, 결국 전체적인 그림을 보면 `LAN`이 모여서 `MAN`을 구성하고 `MAN`이 모여서 `WAN`을 구성하는 구조이다.

{% asset_img 'network-structure.png' 'lan man wan' %}

`Carrier Grade NAT(CGN)`은 
